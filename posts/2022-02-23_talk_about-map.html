<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="renderer" content="webkit"><meta name="author" content="HeZulong"><meta name="keywords" content="何祖龙, hezulong, zulong"><meta name="description" content="何祖龙"><meta name="theme-color" content="#000000"><link rel="icon" href="/logo.png" type="image/svg+xml"><link href="//fonts.googleapis.com/css2?family=Fira+Code&amp;family=Inter:wght@200;400;600&amp;display=swap" rel="stylesheet"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""><link href="//fonts.googleapis.com/css2?family=Kaisei+Decol:wght@400;500;700&amp;display=swap" rel="stylesheet"><title>做了几个月的地图，吐槽发泄下</title><script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><script type="module" async="" crossorigin="" src="/assets/app.ae42083c.js"></script><link rel="modulepreload" href="/assets/vendor.8b079578.js"><link rel="stylesheet" href="/assets/app.c1706c9e.css"><link rel="modulepreload" crossorigin="" href="/assets/2022-02-23_talk_about-map.3721f22c.js"><link rel="modulepreload" crossorigin="" href="/assets/Post.28611235.js"><meta name="description" content="何祖龙的个人网站, hezulong's Portfolio"><meta property="og:title" content="做了几个月的地图，吐槽发泄下"><meta name="head:count" content="2"></head><body class="font-sans text-gray-700 dark:text-gray-200"><div id="app" data-server-rendered="true"><!--[--><header class="header z-40" data-v-7ecc8847=""><a href="/" class="w-8 h-8 absolute lg:fixed m-7 select-none outline-none" focusable="false" data-v-7ecc8847=""><div class="bg-accentLight rounded-full w-8 h-8" data-v-7ecc8847=""></div></a><nav class="nav" data-v-7ecc8847=""><div class="spacer" data-v-7ecc8847=""></div><div class="right" data-v-7ecc8847=""><a href="/posts" class="" data-v-7ecc8847=""><span class="<md:hidden" data-v-7ecc8847="">Blog</span><svg style="vertical-align:sub" class="inline md:hidden" width="1.2em" height="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32" data-v-7ecc8847=""><path fill="currentColor" d="M26 30H6a2.002 2.002 0 0 1-2-2V4a2.002 2.002 0 0 1 2-2h20a2.002 2.002 0 0 1 2 2v24a2.002 2.002 0 0 1-2 2ZM6 4v24h20V4Z"></path><path fill="currentColor" d="M9 7h11v2H9zm0 5h7v2H9z"></path></svg></a><a href="/talks" class="<md:hidden" data-v-7ecc8847="">Talks </a><a href="/projects" class="" data-v-7ecc8847=""><span class="<md:hidden" data-v-7ecc8847="">Projects</span><svg style="vertical-align:sub" class="inline md:hidden" width="1.2em" height="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32" data-v-7ecc8847=""><path fill="currentColor" d="M11 24h10v2H11zm2 4h6v2h-6zm3-26A10 10 0 0 0 6 12a9.19 9.19 0 0 0 3.46 7.62c1 .93 1.54 1.46 1.54 2.38h2c0-1.84-1.11-2.87-2.19-3.86A7.2 7.2 0 0 1 8 12a8 8 0 0 1 16 0a7.2 7.2 0 0 1-2.82 6.14c-1.07 1-2.18 2-2.18 3.86h2c0-.92.53-1.45 1.54-2.39A9.18 9.18 0 0 0 26 12A10 10 0 0 0 16 2z"></path></svg></a><!----><!----><!----></div></nav></header><main class="px-7 py-10"><!--[--><div class="prose m-auto mb-8"><h1 class="mb-0">做了几个月的地图，吐槽发泄下</h1><p class="opacity-50 !-mt-2">02月23日 <span>· 5分钟</span></p><p class="opacity-50 !-mt-6 italic">文章首发于 2021/06/15，这里只是迁移</p></div><article><!--[--><div class="prose m-auto"><blockquote><p>不知道怎么排版布局了，凑合着看吧，主要自己用</p></blockquote><p>研究地图有一段时间了，资料看了一堆一堆的，各家也都有自己的风格。因为需要找适合公司的地图服务，以往的百度/高德地图完全不合适，所以需要另寻出路。</p><p>公司要求：</p><ul><li>兼容天地图（首要）</li><li>加载一些 3D 模型（次要）</li><li>最好兼容倾斜摄影</li></ul><p>其实研究过地图的都知道，基本非 <a href="https://cesium.com/platform/cesiumjs/" target="_blank" rel="noopener"><code>cesium</code></a> 莫属，但是研究2个月，demo 例子也做了一些，除了一些简单的，但凡需要酷炫的效果，着实无从下手。加之 cesium 文档实在是耐不住性子看下去，最终我是放弃了。</p><p>但是公司的业务是要进行下去的，退而求其次，我打算重新找一款地图处理方案：</p><ul><li><strong>天地图自身</strong>：基础使用还行，但是一旦深入了解，真的不知道怎么办，源码被压缩加密，文档写的也是随心所欲，样式主题少的可怜，</li><li><strong>Mapbox</strong>：看到介绍，真的非常炫酷，加之 api 简单，且定制化特别高，与<code>three.js</code>，<code>d3.js</code>可以很好的结合，唯一尴尬的就是坐标系仅仅支持墨卡托。其实，我也找到了相关的解决方案。即兼容各类坐标系，<a href="https://github.com/cgcs2000/mapbox-gl-js" target="_blank" rel="noopener"><code>cgcs2000/mapbox-gl-js</code></a>，但是感觉那只是披着<code>mapbox</code>的另一个gis 处理工具。</li><li><strong>Leaflet</strong>：和 <strong>Mapbox</strong> 一家子的，api 也高度类似，里面的插件很多，目前我找到2个，<code>leaflet.chinatmsproviders</code> 和 <code>esri-leaflet</code>，但是对我来说并没有啥用，代码看了下，感觉很厉害的样子。</li></ul><p>毕竟不是专业 GIS 人士，而这玩意要想玩的溜，还得要花大量的时间在上面，目前我也是在不停的摸索中</p><h2 id="leaflet-加载经纬度投影的天地图" tabindex="-1">Leaflet 加载经纬度投影的天地图 <a class="header-anchor" href="#leaflet-加载经纬度投影的天地图" aria-hidden="true">#</a></h2><blockquote><p>这里记录经纬度投影的天地图代码，以便以后使用 墨卡托投影的网上一大堆，自己找，但是我还是建议直接使用 mapbox，因为那是真的好看啊😄</p></blockquote><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token constant">L</span> <span class="token keyword">from</span> <span class="token string">'leaflet'</span>

<span class="token keyword">function</span> <span class="token function">object2params</span><span class="token punctuation">(</span><span class="token parameter">o</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> k <span class="token keyword">in</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> o<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ret <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&amp;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> k <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> o<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> ret<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'?'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">generateTDBaseConfig</span> <span class="token operator">=</span> <span class="token parameter">layer</span> <span class="token operator">=&gt;</span> <span class="token function">object2params</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token constant">SERVICE</span><span class="token operator">:</span> <span class="token string">'WMTS'</span><span class="token punctuation">,</span>
  <span class="token constant">REQUEST</span><span class="token operator">:</span> <span class="token string">'GetTile'</span><span class="token punctuation">,</span>
  <span class="token constant">VERSION</span><span class="token operator">:</span> <span class="token string">'1.0.0'</span><span class="token punctuation">,</span>
  <span class="token constant">STYLE</span><span class="token operator">:</span> <span class="token string">'default'</span><span class="token punctuation">,</span>
  <span class="token constant">FORMAT</span><span class="token operator">:</span> <span class="token string">'tiles'</span><span class="token punctuation">,</span>
  <span class="token constant">TILEMATRIXSET</span><span class="token operator">:</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token comment">// 注意这里调整为 c，不是 w</span>
  <span class="token constant">TILEMATRIX</span><span class="token operator">:</span> <span class="token string">'{z}'</span><span class="token punctuation">,</span>
  <span class="token constant">TILEROW</span><span class="token operator">:</span> <span class="token string">'{y}'</span><span class="token punctuation">,</span>
  <span class="token constant">TILECOL</span><span class="token operator">:</span> <span class="token string">'{x}'</span><span class="token punctuation">,</span>
  <span class="token constant">LAYER</span><span class="token operator">:</span> layer<span class="token punctuation">,</span>
  <span class="token literal-property property">tk</span><span class="token operator">:</span> <span class="token string">'you token'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> tdtVectorMap <span class="token operator">=</span> <span class="token string">'http://t{s}.tianditu.gov.cn/vec_c/wmts'</span> <span class="token operator">+</span> <span class="token function">generateTDBaseConfig</span><span class="token punctuation">(</span><span class="token string">'vec'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> tdtVectorLabel <span class="token operator">=</span> <span class="token string">'http://t{s}.tianditu.gov.cn/cva_c/wmts'</span> <span class="token operator">+</span> <span class="token function">generateTDBaseConfig</span><span class="token punctuation">(</span><span class="token string">'cva'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> layerOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">maxZoom</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
  <span class="token literal-property property">minZoom</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">zoomOffset</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">subdomains</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'0'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">,</span> <span class="token string">'5'</span><span class="token punctuation">,</span> <span class="token string">'6'</span><span class="token punctuation">,</span> <span class="token string">'7'</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> normalm <span class="token operator">=</span> <span class="token constant">L</span><span class="token punctuation">.</span><span class="token function">tileLayer</span><span class="token punctuation">(</span>tdtVectorMap<span class="token punctuation">,</span> layerOptions<span class="token punctuation">)</span>
<span class="token keyword">const</span> normala <span class="token operator">=</span> <span class="token constant">L</span><span class="token punctuation">.</span><span class="token function">tileLayer</span><span class="token punctuation">(</span>tdtVectorLabel<span class="token punctuation">,</span> layerOptions<span class="token punctuation">)</span>

<span class="token keyword">const</span> thirdLayer <span class="token operator">=</span> <span class="token constant">L</span><span class="token punctuation">.</span><span class="token function">tileLayer</span><span class="token punctuation">(</span><span class="token string">'you EPSG4326 server url'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">zoomOffset</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token comment">// 注意这里和上面的 layerOptions 保持一致，又是个坑的地方</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> normal <span class="token operator">=</span> <span class="token constant">L</span><span class="token punctuation">.</span><span class="token function">layerGroup</span><span class="token punctuation">(</span><span class="token punctuation">[</span> normalm<span class="token punctuation">,</span> thirdLayer<span class="token punctuation">,</span> normala <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 注意这里的排序，越靠前越在地图底层</span>

<span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token constant">L</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token string">'you dom'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">center</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 调整成自己需要的中心点</span>
  <span class="token literal-property property">zoom</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
  <span class="token literal-property property">layers</span><span class="token operator">:</span> <span class="token punctuation">[</span> normal <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">crs</span><span class="token operator">:</span> <span class="token constant">L</span><span class="token punctuation">.</span><span class="token constant">CRS</span><span class="token punctuation">.</span><span class="token constant">EPSG4326</span> <span class="token comment">// 一定要设置</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><hr><p>2021-06-15: 后续在补充吧</p></div><!--]--></article><div class="prose m-auto mt-8 mb-8"><a href="/posts" class="font-mono no-underline opacity-50 hover:opacity-75">cd ..</a></div><!--]--><footer class="prose m-auto py-20 flex"><span class="text-sm">2018 - PRESENT © HeZulong</span><div class="flex-auto"></div></footer></main><!--]--></div><script></script></body></html>